{% extends "base.html" %}

<body>
{% load static %}
{% block title %}Home{% endblock %}

{% block content %}

    {% if user.is_authenticated %}
        <h2>checkout</h2>
        <h2>{{id}}</h2>


    <div id="checkout">
            <!-- <form action="/create-order-item/" method="post"> -->
                {% csrf_token %}
                {% for product in cartDict %}
                <input type="hidden" name="product_id" class="products" value="{{product.id}}">
                <div class="cart-product">
                    <img src="/media/{{product.image}}" alt="" class="product-img">
                    <div class="cart-details">
                        <p class="product-name">{{product.id}}{{product.name|truncatewords_html:5}}</p>

                        <div class="modify-action-btns">
                            <div class="modify-quantity"> 
                                <button type="button" id="sub-{{product.id}}" class="quantity-btn add-quantity" onclick="subQuantity({{product.id}},{{product.price}})">-</button>
                                <input type="number" id="product-{{product.id}}" class="quantity" name="quantity" value="{{product.quantity}}" readonly>
                                <button type="button" id="add-{{product.id}}" class="quantity-btn sub-quantity" onclick="addQuantity({{product.id}},{{product.price}})">+</button>
                            </div>     
                            <input type="number" class="product-price price" name="amount" value="{{product.tot_price}}" id="tot_price-{{product.id}}" readonly>
                           
                        </div>
                    </div>
                </div>
                {% endfor %}
                <br>
            
                <div id="checkout-actions">
                    <a href="#"><button id="cancel-btn" onclick="confirmOrder()">Cancel</button></a>
                    <a href="#" onclick="submitCheckout"><button id="checkout-btn">Confirm Order</button></a>
                </div>
            <!-- </form> -->
    </div>

    <script>
        const products = document.getElementsByClassName('products');
        const quantity = document.getElementsByClassName('quantity');
        const confirmBtn = document.getElementById("checkout-btn");
        var cart = [];
        confirmBtn.addEventListener('click', function(){
            for(let i=0; i<products.length;i++){
                let product = {};
                product.id = products[i].value;
                product.quantity = quantity[i].value;
                cart = [...cart,{...product}];
            }
            console.log(cart);
        });

        function submitCheckout(user,cart){
            console.log('Submitting checkout');
            var xhr = new XMLHttpRequest();
            let cookie = document.cookie;
            var csrfToken = localStorage.getItem('csrfToken');

            var formData = new FormData();
            formData.append('csrfmiddlewaretoken',csrfToken);
            formData.append('user_id',user);
            formData.append('cart',cart);
            
            xhr.onreadystatechange = function(){
                    if (xhr.readyState === XMLHttpRequest.DONE){
                        if( xhr.status === 200){
                            console.log(xhr.responseText);
                        }else{
                            console.error('Error', xhr.status);
                        }
                    }
                };

                xhr.open('POST', '/create-order-item/', true);
                xhr.send(formData);
        }
    </script>
    
    {% endif %}

    {% endblock %}
