{% extends "base.html" %}

<body>
{% load static %}
{% block title %}Checkout{% endblock %}

{% block content %}

    {% if user.is_authenticated %}
    <h2>Checkout</h2>
    {{customer.streetaddr}}
    {{total_amount}}

    <div id="checkout">
                <div id="checkout-actions">
                    <a href="#"><button class="cancel-btn" onclick=history.back()>Cancel</button></a>
                    <a href="#"><button id="checkout-btn">Confirm Order</button></a>
                </div>
    </div>

    <div id="confirm-modal" class="">
        <div id="modal-message">
            <h2>Proceed to create order?</h2>
        </div>
        <div id="modal-cnf-btn">
            <button id="cancel-modal" class="cancel-btn">Cancel</button>
            <button id="checkout-btn" onclick="submitConfirmation({{user.id}})">Confirm</button>
        </div>
    </div>

    <script>
        const products = document.getElementsByClassName('products');
        const quantity = document.getElementsByClassName('quantity');
        const confirmBtn = document.getElementById("checkout-btn");
        const cancelModal = document.getElementById("cancel-modal");
        const modal = document.getElementById('confirm-modal');
        const form = document.getElementById('order-form');
        var cart = [];
        
        confirmBtn.addEventListener('click', function(){
            modal.style.display = 'block';
            document.body.filter = 'blur(8px)';
            for(let i=0; i<products.length;i++){
                let product = {};
                product.id = products[i].value;
                product.quantity = quantity[i].value;
                cart = [...cart,{...product}];
            }
            console.log(cart);
        });
        cancelModal.addEventListener('click', function(){
            modal.style.display = 'none';
            cart = [];
        })

        function submitConfirmation(user){
            console.log('Submitting checkout', user, cart);
            var xhr = new XMLHttpRequest();
            let cookie = document.cookie;
            var csrfToken = localStorage.getItem('csrfToken');

            var formData = new FormData();
            formData.append('csrfmiddlewaretoken',csrfToken);
            formData.append('user_id',user);
            formData.append('cart',JSON.stringify(cart));
            
            xhr.onreadystatechange = function(){
                    if (xhr.readyState === XMLHttpRequest.DONE){
                        if( xhr.status === 200){
                            console.log(xhr.responseText);
                        }else{
                            console.error('Error', xhr.status);
                        }
                    }
                };

                xhr.open('POST', '/create-order-item/', true);
                xhr.send(formData);
                cart=[];
        }
    </script>
    
    {% else %}
    <h2>Please Login</h2>
    {% endif %}

    {% endblock %}
